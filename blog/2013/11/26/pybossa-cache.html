<!DOCTYPE html>
<html lang="en">
    <head>
                <meta charset="utf-8">
        <title>Daniel Lombraña González - Blog - Adding a load balanced & high-availability cache to PyBossa</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Adding a load balanced & high-availability cache to PyBossa">
        <meta name="AUTHOR" content="Daniel Lombraña González">

        <!-- Le styles -->
        <link href="../../../../theme/css/bootstrap.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.2/css/font-awesome.css" rel="stylesheet">
        <link href="../../../../theme/css/style-alt.css" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>


        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

        <!-- Fav and touch icons -->
        <link rel="shortcut icon" href="../assets/ico/favicon.ico">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">
                <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-36769710-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
                        <!-- Placed at the end of the document so the pages load faster -->
        <script src="../../../../theme/js/jquery-1.8.3.min.js"></script>
        <script src="../../../../theme/js/bootstrap.min.js"></script>
        <script src="../../../../theme/js/holder.js"></script>
        <script src="../../../../theme/js/jquery.dotdotdot.min.js"></script>
        <script src="../../../../theme/js/picturefill.js"></script>
    </head>

    <body>
        <!-- NAVBAR
    ================================================== -->
        <!-- Wrap the .navbar in .container to center it on the page and provide easy way to target it with .navbar-wrapper. -->
        <div class="container navbar-wrapper">

            <div class="navbar navbar-inverse">
                <div class="navbar-inner">
                    <!-- Responsive Navbar Part 1: Button for triggering responsive navbar (not covered in tutorial). Include responsive CSS to utilize. -->
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand brand-title" href="../../../..">Daniel Lombraña</a>
                    <!-- Responsive Navbar Part 2: Place all navbar contents you want collapsed withing .navbar-collapse.collapse. -->
                    <div class="nav-collapse collapse">
                        <ul class="nav">
                            <li ><a href="../../../../index.html">Projects</a></li>
                            <li  class="active" ><a href="../../../../blog/index.html">Blog</a></li>
                            <li ><a href="../../../../pages/photography.html">Photography</a></li>
                            <li ><a href="../../../../pages/about.html">About</a></li>
                            <li ><a href="../../../../pages/contact.html">Contact</a></li>
                        </ul>
                    </div><!--/.nav-collapse -->
                </div><!-- /.navbar-inner -->
            </div><!-- /.navbar -->

        </div><!-- /.container -->

        <div class="container content">
    <div class="row">
        <div class="span12">
            <h1>Adding a load balanced & high-availability cache to PyBossa</h1>
        </div>
    </div>
    <div class="row-fluid">
        <div class="entry span8">
            <p>In the last days I have been working really hard to add a new cache system to PyBossa.</p>
<p>Up to now, <a href="http://daniellombrana.es/pybossa.html">PyBossa</a> has been using <a href="http://pythonhosted.org/Flask-Cache/">Flask-Cache</a>, an extension for the <a href="http://flask.pocoo.org/">Flask</a> micro-framework
that allows you to use several types of caching backends (i.e. <a href="http://memcached.org/">memcached</a> or <a href="http://redis.io">Redis</a>).</p>
<p><a href="http://crowdcrafting.org/">Crowdcrafting</a> was using memcached, as it is a robust solution and it is really well documented.
However in the last days due to high loads in the server, I've been thinking how I can
improve the situation, and have a cache system that meets the following criteria:</p>
<ul>
<li>Load-balanced: queries should be balanced between a master-slave architecture within PyBossa.</li>
<li>High-availability: if one slave or master node goes down, the system should recover itself without having to do anything special in PyBossa.</li>
<li>Persistence: avoid warming up the cache every time you need to reboot the server.</li>
</ul>
<p>After checking several solutions, the best candidate that meets those requirements is: <a href="http://redis.io">Redis</a>.</p>
<p><a href="http://redis.io">Redis</a> is <em>amazing</em>. Let me repeat it: <strong>amazing</strong>. </p>
<p>The reason I decided to start using 
Redis as the main cache for PyBossa is that it has an incredible set of <a href="http://redis.io/topics/introduction">features</a>, 
a very simple master-slave setup, it is asynchronous, and over all those features: it gives you <a href="http://redis.io/topics/sentinel">Sentinel</a>.</p>
<p>Sentinel is a system that allows you to monitor your master-slave setup, and discover 
Redis services in a very simple way. Fortunately, there is a <a href="https://github.com/andymccurdy/redis-py">Python client</a> that uses 
the Sentinel mode, and allows you to connect your Python software to Redis, handling behind
the curtains which nodes are alive and which nodes are not. </p>
<p>As Sentinel is perfect for what I wanted to build, I decided to start using it. 
The result a new PyBossa caching module based on Redis.</p>
<p>The <a href="https://github.com/PyBossa/pybossa/blob/master/pybossa/cache/__init__.py">new module is very simple</a>, it uses Sentinel to discover the master-slave setup
and configure two clients: master and slave. Then, all read actions are loaded from the slave node, and all write actions are done in the master, balancing the 
load between the infrastructure.</p>
<p>The most interesting aspect of this setup, is that you can add more slaves in real time, 
and Sentinel will handle them for you. If the master node dies, then it will look for 
another master to configure it (this needs another Sentinel node), and voile: system 
up and running without having to do any special.</p>
<p>Today I've deployed this new version (bumping PyBossa version to v0.2.0) in <a href="http://crowdcrafting.org">Crowdcrafting</a> 
and the speed of the site is really awesome!</p>
<p>The only "issue" with Redis, is that Ubuntu LTS does not have the most recent version 
of it (not even 2.6), so you have to download it manually, and compile it. The good news are
that after installing the Ubuntu package <em>build-essential</em> you should have all the requirements to run
a simple <em>make</em> command and build it. </p>
<p><strong>NOTE</strong>: in order to add it to the init.d section of Ubuntu, install first the old version via the
package manager, copy the files <em>/etc/init.d/redis-server</em> and <em>/etc/redis/redis.conf</em> to your
home folder, modify them to your needs (use the redis.conf as a guide for your redis.conf 2.6 config
file) and you will be done. Another option is to configure everything with <a href="http://supervisord.org/">Supervisor</a>
which would be pretty handy (mental note, write a blog post about it).</p>
        </div>
        <div class="span4">
            <div class="column-right">
                <a href="http://www.flickr.com/photos/t-klick/10122172655/">
                <span data-picture data-alt="Adding a load balanced & high-availability cache to PyBossa">
                    <span data-src="../../../../static/images/blog/balance_320.jpg"></span>
                    <span data-src="../../../../static/images/blog/balance.jpg"     data-media="(min-width: 768px)"></span>
                </span>
                </a>
                <p><i class="fa fa-picture-o"></i> by <a href="http://www.flickr.com/photos/t-klick/10122172655/">Timm Nüchter</a></p>
                <h3>Written by</h3>
                <p class="lead">Daniel Lombraña</p>
                <img class="img-polaroid" src="../../../../static/images/blog/avatar.jpeg"/>
                </p>
                <p>
                <a href="http://www.shuttleworthfoundation.org/fellows/daniel-lombrana/"><img src="../../../../static/images/blog/shuttleworth-fellow.png"/></a>
                <p class="date">
                <i class="icon-time"></i> Published: 2013-11-26
                </p>
                <h4>Share this post</h4>
                <div id="twitter" >
                    <a href="https://twitter.com/share?url=http://daniellombrana.es/2013/11/26/pybossa-cache.html">
                    <img class="img-circle" src="holder.js/60x60/text: /social"/>
                    <div class="twitter-circle">
                        <i class="fa fa-twitter"></i>
                    </div>
                    </a>
                </div>
                <p class="tags">
                                This entry was tagged with 
                <ul class="tag-list">
                     
                    <li><a href="../../../../tag/cache.html">cache </a></li>
                 
                    <li><a href="../../../../tag/high-availability.html">high-availability </a></li>
                 
                    <li><a href="../../../../tag/load-balance.html">load balance </a></li>
                 
                    <li><a href="../../../../tag/crowdcrafting.html">crowdcrafting </a></li>
                 
                    <li><a href="../../../../tag/pybossa.html">pybossa </a></li>
                                </ul>
                                </p>

            </div>
        </div>
    </div>
    <div class="row hidden-phone">
        <div class="span12">
            <h4>Share it</h4>
        </div>
    </div>
    <div class="row hidden-phone">
        <div id="twitter" class="span4">
            <a href="https://twitter.com/share?url=http://daniellombrana.es/2013/11/26/pybossa-cache.html">
            <img class="img-circle" src="holder.js/60x60/text: /social"/>
            <div class="twitter-circle">
                <i class="fa fa-twitter"></i>
            </div>
            </a>
        </div>
    </div>
    <hr>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'daniellombrana'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    <div id="disqus_thread"></div>
</div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'daniellombrana'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


        <!-- FOOTER -->
        <footer>
            <!--<p class="pull-right"><a href="#">Back to top</a></p>-->
            <p><a href="http://www.shuttleworthfoundation.org/fellows/daniel-lombrana/"><img src="../../../../static/images/blog/shuttleworth-fellow.png"/></a></p>
            <p>&copy; 2013 <a href="../../../../pages/contact.html">Daniel Lombraña</a></p>
        </footer>

    </div><!-- /.container -->

    <!-- Le javascript
    ================================================== -->
    <script>
        !function ($) {
            $(function(){
                // carousel demo
                $('#myCarousel').carousel()
            })
        }(window.jQuery)
    </script>
    <script>
        $(document).ready(function() {
            $("#name").dotdotdot({
                watch: true
            // configuration goes here
            });
        });
    </script>
</body>
<!-- Page built using Pelican http://docs.getpelican.com -->
</html>